
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>porcupine.textwidget &#8212; Porcupine API 0.82.0+git.b4bd1be documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for porcupine.textwidget</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">tkinter</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">overload</span>

<span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">styles</span>  <span class="c1"># type: ignore[import]</span>

<span class="kn">from</span> <span class="nn">porcupine</span> <span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">utils</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">porcupine</span> <span class="kn">import</span> <span class="n">tabs</span>


<div class="viewcode-block" id="Change"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.Change">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Change</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This :mod:`dataclass &lt;dataclasses&gt;` represents any change in a</span>
<span class="sd">    :class:`ChangeTrackingText` widget,</span>
<span class="sd">    where ``old_text_len`` characters between the text widget indexes ``start``</span>
<span class="sd">    and ``end`` get replaced with ``new_text``. For example, this...</span>
<span class="sd">    ::</span>

<span class="sd">        # let&#39;s say that text widget contains &#39;hello world&#39;</span>
<span class="sd">        textwidget.replace(&#39;1.0&#39;, &#39;1.5&#39;, &#39;toot&#39;)</span>

<span class="sd">    \...changes the ``&#39;hello&#39;`` to ``&#39;toot&#39;``, and that&#39;s represented by a</span>
<span class="sd">    ``Change`` like this::</span>

<span class="sd">        Change(start=&#39;1.0&#39;, end=&#39;1.5&#39;, old_text_len=5, new_text=&#39;toot&#39;)</span>

<span class="sd">    Insertions are represented with ``Change`` objects having ``old_text_len=0``</span>
<span class="sd">    and the same ``start`` and ``end``. For example,</span>
<span class="sd">    ``textwidget.insert(&#39;1.0&#39;, &#39;hello&#39;)`` corresponds to this ``Change``::</span>

<span class="sd">        Change(start=&#39;1.0&#39;, end=&#39;1.0&#39;, old_text_len=0, new_text=&#39;hello&#39;)</span>

<span class="sd">    For deletions, ``start`` and ``end`` differ and ``new_text`` is empty.</span>
<span class="sd">    If the first line of a text widget contains at least 5 characters, then</span>
<span class="sd">    deleting the first 5 characters looks like this::</span>

<span class="sd">        Change(start=&#39;1.0&#39;, end=&#39;1.5&#39;, old_text_len=5, new_text=&#39;&#39;)</span>

<span class="sd">    Unlike you might think, the ``old_text_len`` is not redundant. Let&#39;s</span>
<span class="sd">    say that the text widget contains ``&#39;toot world&#39;`` and all that is</span>
<span class="sd">    deleted::</span>

<span class="sd">        Change(start=&#39;1.0&#39;, end=&#39;1.10&#39;, old_text_len=10, new_text=&#39;&#39;)</span>

<span class="sd">    After the deletion, ``&#39;1.10&#39;`` is no longer a valid index in the text</span>
<span class="sd">    widget because it contains 0 characters (and 0 is less than 10).</span>
<span class="sd">    In this case, checking only the ``0`` of ``1.0`` and the ``10`` of ``1.10``</span>
<span class="sd">    could be used to calculate the 10,</span>
<span class="sd">    but that doesn&#39;t work right when changing multiple lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">end</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">old_text_len</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="Changes"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.Changes">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">Changes</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">EventDataclass</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This :mod:`dataclass &lt;dataclasses&gt;` represents a list of several</span>
<span class="sd">    :class:`Change`\ s applied at once.</span>
<span class="sd">    The ``change_list`` is always ordered so that most recent change is</span>
<span class="sd">    ``change_list[-1]`` and the oldest change is ``change_list[0]``.</span>

<span class="sd">    This boilerplate class is needed instead of a plain ``List[Change]``</span>
<span class="sd">    because of how :class:`porcupine.utils.EventDataclass` works.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">change_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Change</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">_ChangeTracker</span><span class="p">:</span>

    <span class="c1"># event_receiver_widget will receive the change events</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_receiver_widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_receiver_widget</span> <span class="o">=</span> <span class="n">event_receiver_widget</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Change</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">old_cursor_pos</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>    <span class="c1"># must be widget specific</span>

        <span class="k">def</span> <span class="nf">cursor_pos_changed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">nonlocal</span> <span class="n">old_cursor_pos</span>

            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_pos</span> <span class="o">==</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span>
                <span class="n">new_pos</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_pos</span> <span class="o">!=</span> <span class="n">old_cursor_pos</span><span class="p">:</span>
                <span class="n">old_cursor_pos</span> <span class="o">=</span> <span class="n">new_pos</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;CursorMoved&gt;&gt;&#39;</span><span class="p">)</span>

        <span class="c1">#       /\</span>
        <span class="c1">#      /  \  WARNING: serious tkinter magic coming up</span>
        <span class="c1">#     / !! \          proceed at your own risk</span>
        <span class="c1">#    /______\</span>
        <span class="c1">#</span>
        <span class="c1"># this irc conversation might give you an idea of how this works:</span>
        <span class="c1">#</span>
        <span class="c1">#    &lt;Akuli&gt; __Myst__, why do you want to know how it works?</span>
        <span class="c1">#    &lt;__Myst__&gt; Akuli: cause it seems cool</span>
        <span class="c1">#    &lt;Akuli&gt; there&#39;s 0 reason to docment it in the langserver</span>
        <span class="c1">#    &lt;Akuli&gt; ok i can explain :)</span>
        <span class="c1">#    &lt;Akuli&gt; in tcl, all statements are command calls</span>
        <span class="c1">#    &lt;Akuli&gt; set x lol    ;# set variable x to string lol</span>
        <span class="c1">#    &lt;Akuli&gt; set is a command, x and lol are strings</span>
        <span class="c1">#    &lt;Akuli&gt; adding stuff to widgets is also command calls</span>
        <span class="c1">#    &lt;Akuli&gt; .textwidget insert end hello   ;# add hello to the text</span>
        <span class="c1">#            widget</span>
        <span class="c1">#    &lt;Akuli&gt; my magic renames the textwidget command to</span>
        <span class="c1">#            actual_widget_command, and creates a fake text widget</span>
        <span class="c1">#            command that tkinter calls instead</span>
        <span class="c1">#    &lt;Akuli&gt; then this fake command checks for all possible widget</span>
        <span class="c1">#            commands that can move the cursor or change the content</span>
        <span class="c1">#    &lt;Akuli&gt; making sense?</span>
        <span class="c1">#    &lt;__Myst__&gt; ooh</span>
        <span class="c1">#    &lt;__Myst__&gt; so it&#39;s like you&#39;re proxying actual calls to the text</span>
        <span class="c1">#               widget and calculating change events based on that?</span>
        <span class="c1">#    &lt;Akuli&gt; yes</span>
        <span class="c1">#    &lt;__Myst__&gt; very cool</span>

        <span class="c1"># all widget stuff is implemented in python and in tcl as calls to a</span>
        <span class="c1"># tcl command named str(widget), and replacing that with a custom</span>
        <span class="c1"># command is a very powerful way to do magic; for example, moving the</span>
        <span class="c1"># cursor with arrow keys calls the &#39;mark set&#39; widget command :D</span>
        <span class="n">actual_widget_command</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_actual_widget&#39;</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;rename&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="p">),</span> <span class="n">actual_widget_command</span><span class="p">)</span>

        <span class="c1"># this part is tcl because i couldn&#39;t get a python callback to work</span>
        <span class="n">widget</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        proc </span><span class="si">%(fake_widget)s</span><span class="s1"> </span><span class="si">{args}</span><span class="s1"> {</span>
<span class="s1">            #puts &quot;</span><span class="si">%(fake_widget)s</span><span class="s1"> $args&quot;</span>

<span class="s1">            # subcommand is e.g. insert, delete, replace, index, search, ...</span>
<span class="s1">            # see text(3tk) for all possible subcommands</span>
<span class="s1">            set subcommand [lindex $args 0]</span>

<span class="s1">            # issue #5: don&#39;t let the cursor to go to the very top or bottom of</span>
<span class="s1">            # the view</span>
<span class="s1">            if {$subcommand == &quot;see&quot;} {</span>
<span class="s1">                # cleaned_index is always a &quot;LINE.COLUMN&quot; string</span>
<span class="s1">                set cleaned_index [</span><span class="si">%(actual_widget)s</span><span class="s1"> index [lindex $args 1]]</span>

<span class="s1">                # from text(3tk): &quot;If index is far out of view, then the</span>
<span class="s1">                # command centers index in the window.&quot; and we want to center</span>
<span class="s1">                # it correctly, so first go to the center, then a few</span>
<span class="s1">                # characters around it, and finally back to center because it</span>
<span class="s1">                # feels less error-prone that way</span>
<span class="s1">                </span><span class="si">%(actual_widget)s</span><span class="s1"> see $cleaned_index</span>
<span class="s1">                </span><span class="si">%(actual_widget)s</span><span class="s1"> see &quot;$cleaned_index - 4 lines&quot;</span>
<span class="s1">                </span><span class="si">%(actual_widget)s</span><span class="s1"> see &quot;$cleaned_index + 4 lines&quot;</span>
<span class="s1">                </span><span class="si">%(actual_widget)s</span><span class="s1"> see $cleaned_index</span>
<span class="s1">                return</span>
<span class="s1">            }</span>

<span class="s1">            set cursor_may_have_moved 0</span>
<span class="s1">            set prepared_event &quot;&quot;</span>

<span class="s1">            # only these subcommands can change the text, but they can also</span>
<span class="s1">            # move the cursor by changing the text before the cursor</span>
<span class="s1">            if {$subcommand == &quot;delete&quot; ||</span>
<span class="s1">                    $subcommand == &quot;insert&quot; ||</span>
<span class="s1">                    $subcommand == &quot;replace&quot;} {</span>
<span class="s1">                set cursor_may_have_moved 1</span>
<span class="s1">                set prepared_event [</span><span class="si">%(change_event_from_command)s</span><span class="s1"> {*}$args]</span>
<span class="s1">            }</span>

<span class="s1">            # it&#39;s important that this comes after the change cb stuff because</span>
<span class="s1">            # this way it&#39;s possible to get old_length in self._change_cb()...</span>
<span class="s1">            # however, it&#39;s also important that this is before the mark set</span>
<span class="s1">            # stuff because the documented way to access the new index in a</span>
<span class="s1">            # &lt;&lt;CursorMoved&gt;&gt; binding is getting it directly from the widget</span>
<span class="s1">            set result [</span><span class="si">%(actual_widget)s</span><span class="s1"> {*}$args]</span>

<span class="s1">            if {$prepared_event != &quot;&quot;} {</span>
<span class="s1">                # must be after calling actual widget command</span>
<span class="s1">                event generate </span><span class="si">%(event_receiver)s</span><span class="s1"> &lt;&lt;ContentChanged&gt;&gt; -data $prepared_event</span>
<span class="s1">            }</span>

<span class="s1">            # only[*] &#39;textwidget mark set insert new_location&#39; can change the</span>
<span class="s1">            # cursor position, because the cursor position is implemented as a</span>
<span class="s1">            # mark named &quot;insert&quot; and there are no other commands that move</span>
<span class="s1">            # marks</span>
<span class="s1">            #</span>
<span class="s1">            # [*] i lied, hehe &gt;:D MUHAHAHA ... inserting text before the</span>
<span class="s1">            # cursor also changes it</span>
<span class="s1">            if {$subcommand == &quot;mark&quot; &amp;&amp;</span>
<span class="s1">                    [lindex $args 1] == &quot;set&quot; &amp;&amp;</span>
<span class="s1">                    [lindex $args 2] == &quot;insert&quot;} {</span>
<span class="s1">                set cursor_may_have_moved 1</span>
<span class="s1">            }</span>

<span class="s1">            if {$cursor_may_have_moved} {</span>
<span class="s1">                </span><span class="si">%(cursor_moved_callback)s</span><span class="s1"></span>
<span class="s1">            }</span>

<span class="s1">            return $result</span>
<span class="s1">        }</span>
<span class="s1">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;fake_widget&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">widget</span><span class="p">),</span>
            <span class="s1">&#39;actual_widget&#39;</span><span class="p">:</span> <span class="n">actual_widget_command</span><span class="p">,</span>
            <span class="s1">&#39;change_event_from_command&#39;</span><span class="p">:</span> <span class="n">widget</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_change_event_from_command</span><span class="p">,</span> <span class="n">widget</span><span class="p">)),</span>
            <span class="s1">&#39;event_receiver&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_receiver_widget</span><span class="p">,</span>
            <span class="s1">&#39;cursor_moved_callback&#39;</span><span class="p">:</span> <span class="n">widget</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">cursor_pos_changed</span><span class="p">),</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">_create_change</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Change</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Change</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
            <span class="n">old_text_len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)),</span>
            <span class="n">new_text</span><span class="o">=</span><span class="n">new_text</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Must be called before widget content actually changes</span>
    <span class="k">def</span> <span class="nf">_change_event_from_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">subcommand</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args_tuple</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">changes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Change</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># search for &#39;pathName delete&#39; in text(3tk)... it&#39;s a wall of text,</span>
        <span class="c1"># and this thing has to implement every detail of that wall</span>
        <span class="k">if</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="c1"># &quot;All indices are first checked for validity before any deletions</span>
            <span class="c1"># are made.&quot; they are already validated, but this doesn&#39;t hurt</span>
            <span class="c1"># imo... but note that rest of this code assumes that this is done!</span>
            <span class="c1"># not everything works in corner cases without this</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args_tuple</span><span class="p">]</span>

            <span class="c1"># tk has a funny abstraction of an invisible newline character at</span>
            <span class="c1"># the end of file, it&#39;s always there but nothing else uses it, so</span>
            <span class="c1"># let&#39;s ignore it</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">old_arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">old_arg</span> <span class="o">==</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>

            <span class="c1"># &quot;If index2 is not specified then the single character at index1</span>
            <span class="c1"># is deleted.&quot; and later: &quot;If more indices are given, multiple</span>
            <span class="c1"># ranges of text will be deleted.&quot; but no mention about combining</span>
            <span class="c1"># these features, this works like the text widget actually behaves</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> + 1 char&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]))</span>

            <span class="c1"># &quot;If index2 does not specify a position later in the text than</span>
            <span class="c1"># index1 then no characters are deleted.&quot;</span>
            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pairs</span>
                     <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>

            <span class="c1"># &quot;They [index pairs, aka ranges] are sorted [...].&quot;</span>
            <span class="c1"># TODO: use the fact that (line, column) tuples sort nicely?</span>
            <span class="k">def</span> <span class="nf">sort_by_range_beginnings</span><span class="p">(</span>
                    <span class="n">range1</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                    <span class="n">range2</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">start1</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">range1</span>
                <span class="n">start2</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">range2</span>
                <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">start2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">start2</span><span class="p">):</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="n">pairs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">sort_by_range_beginnings</span><span class="p">))</span>

            <span class="c1"># &quot;If multiple ranges with the same start index are given, then the</span>
            <span class="c1"># longest range is used. If overlapping ranges are given, then they</span>
            <span class="c1"># will be merged into spans that do not cause deletion of text</span>
            <span class="c1"># outside the given ranges due to text shifted during deletion.&quot;</span>
            <span class="k">def</span> <span class="nf">merge_index_ranges</span><span class="p">(</span>
                    <span class="n">start1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">start2</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start1</span> <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">start2</span><span class="p">)</span> <span class="k">else</span> <span class="n">start2</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end1</span> <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span> <span class="k">else</span> <span class="n">end2</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

            <span class="c1"># loop through pairs of pairs</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="n">end1</span><span class="p">),</span> <span class="p">(</span><span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">end1</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">start2</span><span class="p">):</span>
                    <span class="c1"># they overlap</span>
                    <span class="n">new_pair</span> <span class="o">=</span> <span class="n">merge_index_ranges</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="n">end1</span><span class="p">,</span> <span class="n">start2</span><span class="p">,</span> <span class="n">end2</span><span class="p">)</span>
                    <span class="n">pairs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_pair</span><span class="p">]</span>

            <span class="c1"># &quot;[...] and the text is removed from the last range to the first</span>
            <span class="c1"># range so deleted text does not cause an undesired index shifting</span>
            <span class="c1"># side-effects.&quot;</span>
            <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pairs</span><span class="p">):</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_change</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="c1"># the man page&#39;s inserting section is also kind of a wall of</span>
        <span class="c1"># text, but not as bad as the delete</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s1">&#39;insert&#39;</span><span class="p">:</span>
            <span class="n">text_index</span><span class="p">,</span> <span class="o">*</span><span class="n">other_args</span> <span class="o">=</span> <span class="n">args_tuple</span>
            <span class="n">text_index</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">text_index</span><span class="p">)</span>

            <span class="c1"># &quot;If index refers to the end of the text (the character after the</span>
            <span class="c1"># last newline) then the new text is inserted just before the last</span>
            <span class="c1"># newline instead.&quot;</span>
            <span class="k">if</span> <span class="n">text_index</span> <span class="o">==</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span>
                <span class="n">text_index</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>

            <span class="c1"># we don&#39;t care about the tagList arguments to insert, but we need</span>
            <span class="c1"># to handle the other arguments nicely anyway: &quot;If multiple</span>
            <span class="c1"># chars-tagList argument pairs are present, they produce the same</span>
            <span class="c1"># effect as if a separate pathName insert widget command had been</span>
            <span class="c1"># issued for each pair, in order. The last tagList argument may be</span>
            <span class="c1"># omitted.&quot; i&#39;m not sure what &quot;in order&quot; means here, but i tried</span>
            <span class="c1"># it, and &#39;textwidget.insert(&#39;1.0&#39;, &#39;asd&#39;, [], &#39;toot&#39;, [])&#39; inserts</span>
            <span class="c1"># &#39;asdtoot&#39;, not &#39;tootasd&#39;</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_args</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

            <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_change</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">text_index</span><span class="p">,</span> <span class="n">text_index</span><span class="p">,</span> <span class="n">new_text</span><span class="p">))</span>

        <span class="c1"># an even smaller wall of text that mostly refers to insert and replace</span>
        <span class="k">elif</span> <span class="n">subcommand</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">other_args</span> <span class="o">=</span> <span class="n">args_tuple</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
            <span class="n">new_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">other_args</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span>

            <span class="c1"># more invisible newline garbage</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">):</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>

            <span class="c1"># didn&#39;t find in docs, but tcl throws an error for this</span>
            <span class="k">assert</span> <span class="n">widget</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

            <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_change</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">new_text</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>   <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unexpected subcommand: </span><span class="si">{</span><span class="n">subcommand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># remove changes that don&#39;t actually do anything</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">change</span> <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">start</span> <span class="o">!=</span> <span class="n">change</span><span class="o">.</span><span class="n">end</span>
                <span class="ow">or</span> <span class="n">change</span><span class="o">.</span><span class="n">old_text_len</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="n">change</span><span class="o">.</span><span class="n">new_text</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">Changes</span><span class="p">(</span><span class="n">changes</span><span class="p">))</span> <span class="k">if</span> <span class="n">changes</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>   <span class="c1"># don&#39;t generate event</span>

    <span class="k">def</span> <span class="nf">begin_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;nested calls to change_batch&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">finish_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_event_receiver_widget</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;ContentChanged&gt;&gt;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">Changes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_change_batch</span> <span class="o">=</span> <span class="kc">None</span>


<span class="n">_change_trackers</span><span class="p">:</span> <span class="s1">&#39;weakref.WeakKeyDictionary[tkinter.Text, _ChangeTracker]&#39;</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>


<div class="viewcode-block" id="track_changes"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.track_changes">[docs]</a><span class="k">def</span> <span class="nf">track_changes</span><span class="p">(</span><span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make the text widget emit virtual events whenever its content is modified</span>
<span class="sd">    or the cursor moves.</span>

<span class="sd">    Don&#39;t call this function more than once for the same text widget. Also,</span>
<span class="sd">    don&#39;t call it yourself for the ``textwidget`` of a</span>
<span class="sd">    :class:`~porcupine.tabs.FileTab`, because Porcupine does it automatically.</span>
<span class="sd">    You will get a :class:`RuntimeError` if you screw this up.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Some widget options such as ``undo`` must be set before calling this</span>
<span class="sd">        function. Otherwise the changes might not be detected. I don&#39;t know</span>
<span class="sd">        why that happens and whether it affects other options than ``undo``.</span>

<span class="sd">    After calling ``track_changes(widget)``, the text widget has these virtual</span>
<span class="sd">    events:</span>

<span class="sd">    .. virtualevent:: ContentChanged</span>

<span class="sd">        This event is generated when the text in the widget is modified</span>
<span class="sd">        in any way. Unlike ``&lt;&lt;Modified&gt;&gt;``, this event is simply generated</span>
<span class="sd">        every time the content changes, and there&#39;s no need to unset a flag</span>
<span class="sd">        like ``textwidget.edit_modified(False)`` or anything like that.</span>

<span class="sd">        If you want to know what changed and how, use</span>
<span class="sd">        :func:`porcupine.utils.bind_with_data` and</span>
<span class="sd">        ``event.data_class(Changes)``. For example, this...</span>
<span class="sd">        ::</span>

<span class="sd">            # let&#39;s say that text widget contains &#39;hello world&#39;</span>
<span class="sd">            textwidget.replace(&#39;1.0&#39;, &#39;1.5&#39;, &#39;toot&#39;)</span>

<span class="sd">        ...changes the ``&#39;hello&#39;`` to ``&#39;toot&#39;``, generating a</span>
<span class="sd">        ``&lt;&lt;ContentChanged&gt;&gt;`` event whose ``.data_class(Changes)`` returns</span>
<span class="sd">        a :class:`Changes` object like this::</span>

<span class="sd">            Changes(change_list=[</span>
<span class="sd">                Change(start=&#39;1.0&#39;, end=&#39;1.5&#39;, old_text_len=5, new_text=&#39;toot&#39;),</span>
<span class="sd">            ])</span>

<span class="sd">        The ``&lt;&lt;ContentChanged&gt;&gt;`` event occurs after the text in the text</span>
<span class="sd">        widget has already changed. Also, sometimes many changes are applied</span>
<span class="sd">        at once and ``change_list`` contains more than one item.</span>

<span class="sd">    .. virtualevent:: CursorMoved</span>

<span class="sd">        This event is generated every time the user moves the cursor or</span>
<span class="sd">        it&#39;s moved with a method of the text widget. Use</span>
<span class="sd">        ``textwidget.index(&#39;insert&#39;)`` to find the current cursor</span>
<span class="sd">        position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">widget</span> <span class="ow">in</span> <span class="n">_change_trackers</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;track_changes() called twice for same text widget&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">peer_names</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;track_changes() must be called before create_peer_widget()&quot;</span><span class="p">)</span>

    <span class="n">tracker</span> <span class="o">=</span> <span class="n">_ChangeTracker</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
    <span class="n">_change_trackers</span><span class="p">[</span><span class="n">widget</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracker</span></div>


<div class="viewcode-block" id="change_batch"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.change_batch">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">change_batch</span><span class="p">(</span><span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;A context manager to optimize doing many changes to a text widget.</span>

<span class="sd">    When :func:`track_changes` has been called, every change to a text widget</span>
<span class="sd">    generates a new ``&lt;&lt;ContentChanged&gt;&gt;`` event, and lots of</span>
<span class="sd">    ``&lt;&lt;ContentChanged&gt;&gt;`` events can cause Porcupine to run slowly. To avoid</span>
<span class="sd">    that, you can use this context manager during the changes, like this::</span>

<span class="sd">        with textwidget.change_batch(some_text_widget_with_change_tracking):</span>
<span class="sd">            for thing in big_list_of_things_to_do:</span>
<span class="sd">                textwidget.delete(...)</span>
<span class="sd">                textwidget.insert(...)</span>

<span class="sd">    This does nothing if :func:`track_changes` hasn&#39;t been called.</span>

<span class="sd">    See :source:`porcupine/plugins/indent_block.py` for a complete example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tracker</span> <span class="o">=</span> <span class="n">_change_trackers</span><span class="p">[</span><span class="n">widget</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tracker</span><span class="o">.</span><span class="n">begin_batch</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">tracker</span><span class="o">.</span><span class="n">finish_batch</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_peer_widget"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.create_peer_widget">[docs]</a><span class="k">def</span> <span class="nf">create_peer_widget</span><span class="p">(</span>
    <span class="n">original_text_widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span>
    <span class="n">the_widget_that_becomes_a_peer</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure that *the_widget_that_becomes_a_peer* always has the same content</span>
<span class="sd">    as *original_text_widget*.</span>

<span class="sd">    For details, see the ``PEER WIDGETS`` section in</span>
<span class="sd">    `text(3tk) &lt;https://www.tcl.tk/man/tcl8.7/TkCmd/text.htm&gt;`_.</span>
<span class="sd">    This is useful for e.g. :source:`porcupine/plugins/overview.py`.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        This does **not** create a red text widget::</span>

<span class="sd">            the_widget_that_becomes_a_peer = tkinter.Text(master, background=&#39;red&#39;)</span>
<span class="sd">            create_peer_widget(original_text_widget, the_widget_that_becomes_a_peer)</span>

<span class="sd">        This works better::</span>

<span class="sd">            the_widget_that_becomes_a_peer = tkinter.Text(master)</span>
<span class="sd">            create_peer_widget(original_text_widget, the_widget_that_becomes_a_peer)</span>
<span class="sd">            the_widget_that_becomes_a_peer.config(background=&#39;red&#39;)</span>

<span class="sd">        All widget options of *the_widget_that_becomes_a_peer* are lost when</span>
<span class="sd">        this function is called. I tried to make this function preserve the</span>
<span class="sd">        widget options but that caused weird problems.</span>

<span class="sd">    Notes about using :func:`create_peer_widget` and :func:`track_changes`</span>
<span class="sd">    together:</span>

<span class="sd">        * Call :func:`track_changes` with *original_text_widget*, not with its</span>
<span class="sd">          peers. If you get this wrong, you will get a :class:`RuntimeError`.</span>
<span class="sd">        * Bind to the ``&lt;&lt;ContentChanged&gt;&gt;`` with the original widget, not with</span>
<span class="sd">          the peers. If you get this wrong, your ``&lt;&lt;ContentChanged&gt;&gt;``</span>
<span class="sd">          callback won&#39;t run.</span>
<span class="sd">        * First call :func:`track_changes` and then :func:`create_peer_widget`.</span>
<span class="sd">          If you get this wrong, you will get a :class:`RuntimeError`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Peer widgets are weird in tkinter. Text.peer_create takes in a</span>
    <span class="c1"># widget Tcl name, and then creates a peer widget with that name.</span>
    <span class="c1"># But if you want to create a tkinter widget, then you need to let</span>
    <span class="c1"># the tkinter widget to create a Tcl widget with a name chosen by</span>
    <span class="c1"># tkinter. That has happened already when this function runs.</span>
    <span class="c1">#</span>
    <span class="c1"># Can&#39;t do .destroy() because that screws up winfo_children(). Each tkinter</span>
    <span class="c1"># widget knows its child widgets, and .destroy() would make tkinter no</span>
    <span class="c1"># longer know it. Tkinter&#39;s winfo_children() ignores unknown widgets.</span>
    <span class="n">the_widget_that_becomes_a_peer</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">,</span> <span class="n">the_widget_that_becomes_a_peer</span><span class="p">)</span>
    <span class="n">original_text_widget</span><span class="o">.</span><span class="n">peer_create</span><span class="p">(</span><span class="n">the_widget_that_becomes_a_peer</span><span class="p">)</span>

    <span class="n">change_tracker</span> <span class="o">=</span> <span class="n">_change_trackers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">original_text_widget</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">change_tracker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">change_tracker</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">the_widget_that_becomes_a_peer</span><span class="p">)</span></div>


<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">use_pygments_theme</span><span class="p">(</span><span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Misc</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">use_pygments_theme</span><span class="p">(</span><span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>


<div class="viewcode-block" id="use_pygments_theme"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.use_pygments_theme">[docs]</a><span class="k">def</span> <span class="nf">use_pygments_theme</span><span class="p">(</span>
    <span class="n">widget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Misc</span><span class="p">,</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure *widget* to use the colors of the Pygments theme whenever the</span>
<span class="sd">    currently selected theme changes (see :mod:`porcupine.settings`).</span>
<span class="sd">    Porcupine does that automatically for the ``textwidget`` of each</span>
<span class="sd">    :class:`~porcupine.tabs.FileTab`.</span>

<span class="sd">    If you don&#39;t specify a *callback*, then ``widget`` must be a :class:`tkinter.Text` widget.</span>
<span class="sd">    If you specify a callback, then it will be called like</span>
<span class="sd">    ``callback(foreground_color, background_color)``, and the type of the widget doesn&#39;t matter.</span>

<span class="sd">    .. seealso::</span>
<span class="sd">        This function is used in :source:`porcupine/plugins/linenumbers.py`.</span>
<span class="sd">        Syntax highlighting is implemented in</span>
<span class="sd">        :source:`porcupine/plugins/highlight.py`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">on_style_changed</span><span class="p">(</span><span class="n">junk</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="n">styles</span><span class="o">.</span><span class="n">get_style_by_name</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pygments_style&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="n">style</span><span class="o">.</span><span class="n">background_color</span>

        <span class="c1"># yes, style.default_style can be &#39;#rrggbb&#39;, &#39;&#39; or nonexistent</span>
        <span class="c1"># this is undocumented</span>
        <span class="c1">#</span>
        <span class="c1">#   &gt;&gt;&gt; from pygments.styles import *</span>
        <span class="c1">#   &gt;&gt;&gt; [getattr(get_style_by_name(name), &#39;default_style&#39;, &#39;???&#39;)</span>
        <span class="c1">#   ...  for name in get_all_styles()]</span>
        <span class="c1">#   [&#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;???&#39;, &#39;???&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;,</span>
        <span class="c1">#    &#39;???&#39;, &#39;???&#39;, &#39;&#39;, &#39;#cccccc&#39;, &#39;&#39;, &#39;&#39;, &#39;???&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;,</span>
        <span class="c1">#    &#39;#222222&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;???&#39;, &#39;&#39;]</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="s1">&#39;default_style&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">utils</span><span class="o">.</span><span class="n">invert_color</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span>
                <span class="n">foreground</span><span class="o">=</span><span class="n">fg</span><span class="p">,</span>
                <span class="n">background</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span>
                <span class="n">insertbackground</span><span class="o">=</span><span class="n">fg</span><span class="p">,</span>  <span class="c1"># cursor color</span>
                <span class="n">selectforeground</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span>
                <span class="n">selectbackground</span><span class="o">=</span><span class="n">fg</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>

    <span class="n">widget</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;SettingChanged:pygments_style&gt;&gt;&#39;</span><span class="p">,</span> <span class="n">on_style_changed</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">on_style_changed</span><span class="p">()</span></div>


<div class="viewcode-block" id="config_tab_displaying"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.config_tab_displaying">[docs]</a><span class="k">def</span> <span class="nf">config_tab_displaying</span><span class="p">(</span><span class="n">textwidget</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">,</span> <span class="n">indent_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Make ``textwidget`` display tabs as ``indent_size`` characters wide.</span>

<span class="sd">    For example, if ``indent_size`` is 4, then each tab character will look</span>
<span class="sd">    like be 4 spaces. This function uses the font of the textwidget, so don&#39;t</span>
<span class="sd">    change the font immediately after</span>

<span class="sd">    If ``tag`` is specified, then only the text tagged with the tag is</span>
<span class="sd">    affected, not the entire ``textwidget``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">textwidget</span><span class="o">.</span><span class="n">cget</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">textwidget</span><span class="o">.</span><span class="n">tag_cget</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s1">&#39;font&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">textwidget</span><span class="o">.</span><span class="n">cget</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">)</span>

    <span class="c1"># from the text(3tk) man page: &quot;To achieve a different standard</span>
    <span class="c1"># spacing, for example every 4 characters, simply configure the</span>
    <span class="c1"># widget with “-tabs &quot;[expr {4 * [font measure $font 0]}] left&quot;</span>
    <span class="c1"># -tabstyle wordprocessor”.&quot;</span>
    <span class="n">measure_result</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">textwidget</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;measure&#39;</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
    <span class="n">textwidget</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">tabs</span><span class="o">=</span><span class="p">(</span><span class="n">indent_size</span><span class="o">*</span><span class="n">measure_result</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">),</span> <span class="n">tabstyle</span><span class="o">=</span><span class="s1">&#39;wordprocessor&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="MainText"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.MainText">[docs]</a><span class="k">class</span> <span class="nc">MainText</span><span class="p">(</span><span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Don&#39;t use this. It may be changed later.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab</span><span class="p">:</span> <span class="s1">&#39;tabs.FileTab&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span> <span class="o">=</span> <span class="n">tab</span>
        <span class="n">track_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">use_pygments_theme</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">tab</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;TabSettingChanged:indent_size&gt;&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_indent_size_changed</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_indent_size_changed</span><span class="p">()</span>

        <span class="c1"># FIXME: lots of things have been turned into plugins, but</span>
        <span class="c1"># there&#39;s still wayyyy too much stuff in here...</span>
        <span class="n">partial</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span>     <span class="c1"># pep8 line length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;BackSpace&gt;&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Control-BackSpace&gt;&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Control-Delete&gt;&#39;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Shift-Control-Delete&gt;&#39;</span><span class="p">,</span>
                  <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">shifted</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Shift-Control-BackSpace&gt;&#39;</span><span class="p">,</span>
                  <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_delete</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">shifted</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;parenright&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_closing_brace</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;bracketright&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_closing_brace</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;braceright&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_closing_brace</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># most other things work by default, but these don&#39;t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Control-v&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paste</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Control-y&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redo</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;Control-a&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_all</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_indent_size_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">junk</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config_tab_displaying</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indent_size&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_down</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;tkinter.Event[tkinter.Misc]&#39;</span><span class="p">,</span>
                   <span class="n">shifted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">utils</span><span class="o">.</span><span class="n">BreakOrNone</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This runs when the user presses backspace or delete.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_ranges</span><span class="p">(</span><span class="s1">&#39;sel&#39;</span><span class="p">):</span>
            <span class="c1"># nothing is selected, we can do non-default stuff</span>
            <span class="k">if</span> <span class="n">control_down</span> <span class="ow">and</span> <span class="n">shifted</span><span class="p">:</span>
                <span class="c1"># plan A: delete until end or beginning of line</span>
                <span class="c1"># plan B: delete a newline character if there&#39;s nothing</span>
                <span class="c1">#         to delete with plan A</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">keysym</span> <span class="o">==</span> <span class="s1">&#39;Delete&#39;</span><span class="p">:</span>
                    <span class="n">plan_a</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;insert lineend&#39;</span><span class="p">)</span>
                    <span class="n">plan_b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="s1">&#39;insert + 1 char&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plan_a</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;insert linestart&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                    <span class="n">plan_b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;insert - 1 char&#39;</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">plan_a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">plan_a</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># nothing can be deleted with plan a</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">plan_b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">plan_a</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">keysym</span> <span class="o">==</span> <span class="s1">&#39;BackSpace&#39;</span><span class="p">:</span>
                <span class="n">lineno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">before_cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.0&#39;</span> <span class="o">%</span> <span class="n">lineno</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">before_cursor</span> <span class="ow">and</span> <span class="n">before_cursor</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

                <span class="k">if</span> <span class="n">control_down</span><span class="p">:</span>
                    <span class="c1"># delete previous word</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;PrevWord&gt;&gt;&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">keysym</span> <span class="o">==</span> <span class="s1">&#39;Delete&#39;</span> <span class="ow">and</span> <span class="n">control_down</span><span class="p">:</span>
                <span class="c1"># delete next word</span>
                <span class="n">old_cursor_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;NextWord&gt;&gt;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">old_cursor_pos</span><span class="p">,</span> <span class="s1">&#39;insert&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_on_closing_brace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;tkinter.Event[tkinter.Misc]&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dedent automatically.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s1">&#39;insert&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Insert indentation character(s) at the given location.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tabs2spaces&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># we can&#39;t just add &#39; &#39;*indent_size, for example,</span>
        <span class="c1"># if indent_size is 4 and there are 7 charaters we add 1 space</span>
        <span class="n">indent_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indent_size&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">how_many_chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">space_count</span> <span class="o">=</span> <span class="n">indent_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">how_many_chars</span> <span class="o">%</span> <span class="n">indent_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">space_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dedent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Remove indentation character(s) if possible.</span>

<span class="sd">        This method tries to remove spaces intelligently so that</span>
<span class="sd">        everything&#39;s lined up evenly based on the indentation settings.</span>
<span class="sd">        This method is useful for dedenting whole lines (with location</span>
<span class="sd">        set to beginning of the line) or deleting whitespace in the</span>
<span class="sd">        middle of a line.</span>

<span class="sd">        This returns True if something was done, and False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tabs2spaces&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">):</span>
                <span class="c1"># not deleting from start of line, delete previous char instead</span>
                <span class="n">location</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1"> - 1 char&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">lineno</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> linestart&#39;</span> <span class="o">%</span> <span class="n">location</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> lineend&#39;</span> <span class="o">%</span> <span class="n">location</span><span class="p">)</span>

        <span class="n">indent_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tab</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indent_size&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">column</span> <span class="o">-</span> <span class="p">(</span><span class="n">column</span> <span class="o">%</span> <span class="n">indent_size</span><span class="p">)</span>   <span class="c1"># round down to indent_size multiple</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">column</span> <span class="ow">and</span> <span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>    <span class="c1"># prefer deleting from left side</span>
            <span class="n">start</span> <span class="o">-=</span> <span class="n">indent_size</span>
        <span class="k">assert</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="c1"># try to delete as much of full indent as possible without going past</span>
        <span class="c1"># end of line or deleting non-whitespace</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">indent_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="n">end</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># location argument must be in the range that gets deleted</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">assert</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lineno</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_redo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;tkinter.Event[tkinter.Misc]&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">utils</span><span class="o">.</span><span class="n">BreakOrNone</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;Redo&gt;&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

    <span class="k">def</span> <span class="nf">_paste</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;tkinter.Event[tkinter.Misc]&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">utils</span><span class="o">.</span><span class="n">BreakOrNone</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;Paste&gt;&gt;&#39;</span><span class="p">)</span>

        <span class="c1"># by default, selected text doesn&#39;t go away when pasting</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sel_start</span><span class="p">,</span> <span class="n">sel_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag_ranges</span><span class="p">(</span><span class="s1">&#39;sel&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># nothing selected</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sel_start</span><span class="p">,</span> <span class="n">sel_end</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;break&#39;</span>

    <span class="k">def</span> <span class="nf">_select_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="s1">&#39;tkinter.Event[tkinter.Misc]&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">utils</span><span class="o">.</span><span class="n">BreakOrNone</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag_add</span><span class="p">(</span><span class="s1">&#39;sel&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;end - 1 char&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;break&#39;</span></div>


<div class="viewcode-block" id="create_passive_text_widget"><a class="viewcode-back" href="../../textwidget.html#porcupine.textwidget.create_passive_text_widget">[docs]</a><span class="k">def</span> <span class="nf">create_passive_text_widget</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Widget</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a text widget that is meant to be used for displaying text, not for editing.</span>

<span class="sd">    The returned text widget is disabled by default (``state=&#39;disabled&#39;``),</span>
<span class="sd">    and it&#39;s intended to be used that way. You need to temporarily enable it</span>
<span class="sd">    to add text to it::</span>

<span class="sd">        widget = create_passive_text_widget(parent)</span>
<span class="sd">        widget.config(state=&#39;normal&#39;)</span>
<span class="sd">        widget.insert(1.0, wall_of_text)</span>
<span class="sd">        widget.config(state=&#39;disabled&#39;)</span>

<span class="sd">    When creating the widget, this function uses some default settings (such as</span>
<span class="sd">    ``wrap=&#39;word&#39;`` and ``state=&#39;disabled&#39;``) that can be overrided with</span>
<span class="sd">    ``**kwargs``. For example, the above example code can be written like this::</span>

<span class="sd">        widget = create_passive_text_widget(parent, state=&#39;normal&#39;)</span>
<span class="sd">        widget.insert(1.0, wall_of_text)</span>
<span class="sd">        widget.config(state=&#39;disabled&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;TkDefaultFont&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;borderwidth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;relief&#39;</span><span class="p">,</span> <span class="s1">&#39;flat&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;wrap&#39;</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">)</span>       <span class="c1"># TODO: remember to mention in docs</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">)</span>  <span class="c1"># TODO: remember to mention in docs</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">tkinter</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_colors</span><span class="p">(</span><span class="n">junk</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># tkinter&#39;s ttk::style api sucks so let&#39;s not use it</span>
        <span class="n">ttk_fg</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;ttk::style lookup TLabel.label -foreground&#39;</span><span class="p">)</span>
        <span class="n">ttk_bg</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">tk</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;ttk::style lookup TLabel.label -background&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ttk_fg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ttk_bg</span><span class="p">:</span>
            <span class="c1"># stupid ttk theme, it deserves this</span>
            <span class="n">ttk_fg</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
            <span class="n">ttk_bg</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ttk_bg</span><span class="p">:</span>
            <span class="c1"># this happens with e.g. elegance theme (more_plugins/ttkthemes.py)</span>
            <span class="n">ttk_bg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">invert_color</span><span class="p">(</span><span class="n">ttk_fg</span><span class="p">,</span> <span class="n">black_or_white</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">ttk_fg</span><span class="p">:</span>
            <span class="n">ttk_fg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">invert_color</span><span class="p">(</span><span class="n">ttk_bg</span><span class="p">,</span> <span class="n">black_or_white</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">text</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">foreground</span><span class="o">=</span><span class="n">ttk_fg</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">ttk_bg</span><span class="p">,</span> <span class="n">highlightbackground</span><span class="o">=</span><span class="n">ttk_bg</span><span class="p">)</span>

    <span class="c1"># even non-ttk widgets can handle &lt;&lt;ThemeChanged&gt;&gt;</span>
    <span class="c1"># TODO: make sure that this works</span>
    <span class="n">text</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;ThemeChanged&gt;&gt;&#39;</span><span class="p">,</span> <span class="n">update_colors</span><span class="p">,</span> <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">update_colors</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">text</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Porcupine API</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-intro.html">Introduction to Writing Plugins</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../porcupine.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine</span></code> — The top level Porcupine package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../menubar.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.menubar</span></code> — The menu bar at the top of the Porcupine window</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tabs.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.tabs</span></code> — The tab manager and tabs in it</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../textwidget.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.textwidget</span></code> — Things for <code class="docutils literal notranslate"><span class="pre">tkinter.Text</span></code> widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../images.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.images</span></code> — Load images that come with Porcupine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dirs.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.dirs</span></code> — Paths to Porcupine’s files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.settings</span></code> — Porcupine’s setting manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pluginloader.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.pluginloader</span></code> — The module that loads plugins on startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">porcupine.utils</span></code> — Handy utility functions and classes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Akuli.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>